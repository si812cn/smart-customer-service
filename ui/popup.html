<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>智能客服控制台</title>
    <link rel="stylesheet" type="text/css" href="css/layui.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
        }
        .box {
            height: auto;
            padding: 20px;
            color: #333;
            width: 500px;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .guideNotice {
            background: linear-gradient(145deg, #f1f4fe, #e8f0ff);
            padding: 15px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            line-height: 1.8;
            font-size: 14px;
            margin: 15px 0;
            border: 1px solid #e0e7fd;
        }
        .mainTitle {
            display: flex;
            margin-bottom: 25px;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .mainTitle img {
            width: 42px;
            transition: transform 0.3s;
        }
        .mainTitle img:hover {
            transform: scale(1.1);
        }
        .mainTitle h1 {
            margin-left: 15px;
            font-size: 24px;
            color: #2d3748;
        }
        h3 {
            margin: 20px 0 15px;
            color: #2d3748;
            font-size: 18px;
        }
        .layui-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #007aff;
            color: white;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 4px;
            font-size: 14px;
        }
        .layui-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: #0056b3;
        }
        .layui-btn:disabled {
            background: #ccc !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .version {
            margin-top: 25px;
            color: #666;
            font-size: 13px;
        }
        .version b {
            color: #1e88e5;
        }
        /* 新增：反馈提示 */
        .feedback {
            margin-top: 12px;
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 4px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .feedback.success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        .feedback.error {
            background: #fff2f0;
            color: #f5222d;
            border: 1px solid #f5222d;
        }
        /* 按钮组布局 */
        .btn-group {
            margin: 10px 0;
        }
    </style>
</head>
<body>
<div class="box">
    <div class="mainTitle">
        <img src="../icons/icon128.png" alt="插件图标" />
        <h1>智能客服插件</h1>
    </div>

    <div class="guideNotice">
        安装完后，点不开？点了开始，没反应？<br/>
        每次新加载插件后，要在被控页面上刷新下，才能点击生效。而且，不要在浏览器入口页操作，也不要在插件管理页操作，这些页面不是正常网址，是打不开任何插件的。
    </div>

    <div>
        <h3>直播或客服工具</h3>
        <div class="btn-group">
            <a class="layui-btn" id="start">开始使用</a>
            <a class="layui-btn" id="test">测试AI回复</a>
            <a class="layui-btn" id="copyCookie">复制Cookie</a>
            <a class="layui-btn" id="networkCatch">网络监听</a>
        </div>

        <h3>开发者</h3>
        <a class="layui-btn" href="https://m.liuma.net" target="_blank">金纺智能</a>
        <div class="version">版本：<b>250813</b></div>

        <!-- 反馈提示 -->
        <div id="feedback" class="feedback"></div>
    </div>
</div>

<!-- ✅ 内联脚本（也可外联，但需确保加载顺序） -->
<script>
    (() => {
        // 工具函数：获取当前标签页
        function getCurrentTab() {
            return new Promise((resolve) => {
                chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
                    if (chrome.runtime.lastError) {
                        console.error("Tab query error:", chrome.runtime.lastError);
                        resolve(null);
                    } else {
                        resolve(tabs?.[0] || null);
                    }
                });
            });
        }

        // 发送消息并反馈
        function sendMessage(tabId, message) {
            chrome.tabs.sendMessage(tabId, message, (response) => {
                if (chrome.runtime.lastError) {
                    console.error("Message send failed:", chrome.runtime.lastError.message);
                    showFeedback("发送失败，请刷新页面重试", "error");
                } else {
                    showFeedback("指令已发送", "success");
                }
            });
        }

        // 显示反馈
        function showFeedback(msg, type = 'info') {
            const el = document.getElementById('feedback');
            if (!el) return;
            el.textContent = msg;
            el.className = `feedback ${type}`;
            el.style.opacity = 1;
            setTimeout(() => { el.style.opacity = 0; }, 2000);
        }

        // 按钮事件绑定
        const buttons = {
            start: { type: "showConfigHtml" },
            test: { type: "showTestDialog" },
            copyCookie: { type: "copyCookie" },
            networkCatch: { type: "networkCatch" }
        };

        for (const [id, message] of Object.entries(buttons)) {
            const btn = document.getElementById(id);
            if (!btn) continue;

            btn.addEventListener('click', async function () {
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = '发送中...';

                const tab = await getCurrentTab();
                if (!tab) {
                    showFeedback("无法获取当前页面，请刷新后重试", "error");
                    btn.disabled = false;
                    btn.textContent = originalText;
                    return;
                }

                sendMessage(tab.id, { ...message, tabId: tab.id });

                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }, 1000);
            });
        }
    })();
</script>
</body>
</html>